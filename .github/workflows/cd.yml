name: CD - Release & Push to Docker Hub

on:
  push:
    branches:
      - main

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  GO_VERSION: "1.25"
  DOCKERHUB_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/zedaapi
  DOCKERHUB_MANAGER_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager
  DOCKERHUB_MANAGER_WORKERS_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager-workers

jobs:
  # ======================================
  # Job: Semantic Release
  # ======================================
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install semantic-release dependencies
        run: |
          npm install -g \
            semantic-release@latest \
            @semantic-release/changelog@latest \
            @semantic-release/git@latest \
            @semantic-release/github@latest \
            @semantic-release/exec@latest \
            conventional-changelog-conventionalcommits@latest

      - name: Fetch all tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          git fetch --tags --force

      - name: Run Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release || echo "No release needed"

      - name: Display release info
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "New release: v${{ steps.semantic.outputs.new_release_version }}"

  # ======================================
  # Job: Sync to Public Repository
  # ======================================
  sync-public-repo:
    name: Sync to use-zedaapi
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    permissions:
      contents: read
    steps:
      - name: Checkout zedaapi (private)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Generate Postman Collection from OpenAPI
        run: |
          npx openapi-to-postmanv2 \
            -s api/docs/openapi.json \
            -o /tmp/zedaapi.postman.json \
            -p

      - name: Checkout use-zedaapi (public)
        uses: actions/checkout@v4
        with:
          repository: Setup-Automatizado/use-zedaapi
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          path: public-repo

      - name: Sync files
        env:
          VERSION: ${{ needs.release.outputs.new_release_version }}
        run: |
          # Criar diretórios
          mkdir -p public-repo/openapi public-repo/postman

          # Copiar OpenAPI specs (latest + versionado)
          cp api/docs/openapi.json "public-repo/openapi/openapi-latest.json"
          cp api/docs/openapi.yaml "public-repo/openapi/openapi-latest.yaml"
          cp api/docs/openapi.json "public-repo/openapi/openapi-v${VERSION}.json"
          cp api/docs/openapi.yaml "public-repo/openapi/openapi-v${VERSION}.yaml"

          # Copiar Postman Collection (latest + versionado)
          cp /tmp/zedaapi.postman.json "public-repo/postman/zedaapi-latest.postman.json"
          cp /tmp/zedaapi.postman.json "public-repo/postman/zedaapi-v${VERSION}.postman.json"

          # Copiar CHANGELOG.md
          cp CHANGELOG.md public-repo/CHANGELOG.md

          # Atualizar badge de versão nos READMEs
          for readme in public-repo/README.md public-repo/README.en.md public-repo/README.es.md; do
            if [ -f "$readme" ]; then
              sed -i "s|version-v[0-9]*\.[0-9]*\.[0-9]*-|version-v${VERSION}-|g" "$readme"
              sed -i "s|Versão atual: \`v[0-9]*\.[0-9]*\.[0-9]*\`|Versão atual: \`v${VERSION}\`|g" "$readme"
              sed -i "s|Current version: \`v[0-9]*\.[0-9]*\.[0-9]*\`|Current version: \`v${VERSION}\`|g" "$readme"
              sed -i "s|Versión actual: \`v[0-9]*\.[0-9]*\.[0-9]*\`|Versión actual: \`v${VERSION}\`|g" "$readme"
            fi
          done

      - name: Commit and push
        working-directory: public-repo
        env:
          VERSION: ${{ needs.release.outputs.new_release_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: sync v${VERSION} — OpenAPI, Postman & Changelog"
          git push origin main

      - name: Create release in use-zedaapi
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          VERSION: ${{ needs.release.outputs.new_release_version }}
        run: |
          # Extrair release notes da versão atual do CHANGELOG
          NOTES=$(awk "/^## \[${VERSION}\]/{found=1;next} /^## \[/{if(found)exit} found{print}" CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            NOTES="Release v${VERSION} — Veja o changelog completo em: https://github.com/Setup-Automatizado/use-zedaapi/blob/main/CHANGELOG.md"
          fi

          # Criar release com assets
          cat > /tmp/release-body.md << RELEASE_EOF
          ## O que mudou

          ${NOTES}

          ---

          **Downloads:**
          - [OpenAPI JSON](https://github.com/Setup-Automatizado/use-zedaapi/blob/main/openapi/openapi-v${VERSION}.json)
          - [OpenAPI YAML](https://github.com/Setup-Automatizado/use-zedaapi/blob/main/openapi/openapi-v${VERSION}.yaml)
          - [Postman Collection](https://github.com/Setup-Automatizado/use-zedaapi/blob/main/postman/zedaapi-v${VERSION}.postman.json)

          **Documentação:** https://api.zedaapi.com/docs
          **Dashboard:** https://zedaapi.com
          RELEASE_EOF

          gh release create "v${VERSION}" \
            --repo Setup-Automatizado/use-zedaapi \
            --title "v${VERSION}" \
            --notes-file /tmp/release-body.md \
            "public-repo/openapi/openapi-v${VERSION}.json#OpenAPI JSON Spec" \
            "public-repo/openapi/openapi-v${VERSION}.yaml#OpenAPI YAML Spec" \
            "public-repo/postman/zedaapi-v${VERSION}.postman.json#Postman Collection"

  # ======================================
  # Job: Build & Push API to Docker Hub
  # ======================================
  docker-api:
    name: Build & Push API
    runs-on: ubuntu-latest
    needs: release
    if: always()
    permissions:
      contents: read
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          CURRENT_VERSION="$(cat VERSION 2>/dev/null | tr -d '[:space:]')"
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="unknown"
          fi

          if [ "${{ needs.release.outputs.new_release_published }}" = "true" ]; then
            VERSION="${{ needs.release.outputs.new_release_version }}"
          else
            VERSION="${CURRENT_VERSION}"
          fi

          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: v${VERSION}"

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.VERSION }}
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=WhatsApp API
            org.opencontainers.image.description=WhatsApp Web Multi-device API
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push API image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          target: production
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}

      - name: Display image info
        run: |
          echo "Docker image pushed to Docker Hub"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  # ======================================
  # Job: Build & Push Manager to Docker Hub
  # ======================================
  docker-manager:
    name: Build & Push Manager
    runs-on: ubuntu-latest
    needs: release
    if: always()
    permissions:
      contents: read
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          CURRENT_VERSION="$(cat VERSION 2>/dev/null | tr -d '[:space:]')"
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="unknown"
          fi

          if [ "${{ needs.release.outputs.new_release_published }}" = "true" ]; then
            VERSION="${{ needs.release.outputs.new_release_version }}"
          else
            VERSION="${CURRENT_VERSION}"
          fi

          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: v${VERSION}"

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_MANAGER_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.VERSION }}
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=ZedaAPI Manager
            org.opencontainers.image.description=SaaS Management Dashboard for ZedaAPI
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Manager image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./manager-zedaapi
          file: ./manager-zedaapi/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Display image info
        run: |
          echo "Manager image pushed to Docker Hub"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  # ======================================
  # Job: Build & Push Manager Workers to Docker Hub
  # ======================================
  docker-manager-workers:
    name: Build & Push Manager Workers
    runs-on: ubuntu-latest
    needs: release
    if: always()
    permissions:
      contents: read
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          CURRENT_VERSION="$(cat VERSION 2>/dev/null | tr -d '[:space:]')"
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="unknown"
          fi

          if [ "${{ needs.release.outputs.new_release_published }}" = "true" ]; then
            VERSION="${{ needs.release.outputs.new_release_version }}"
          else
            VERSION="${CURRENT_VERSION}"
          fi

          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: v${VERSION}"

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_MANAGER_WORKERS_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.VERSION }}
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=ZedaAPI Manager Workers
            org.opencontainers.image.description=BullMQ Background Workers for ZedaAPI Manager
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Manager Workers image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./manager-zedaapi
          file: ./manager-zedaapi/Dockerfile.workers
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Display image info
        run: |
          echo "Manager Workers image pushed to Docker Hub"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  # ======================================
  # Job: Summary
  # ======================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [release, sync-public-repo, docker-api, docker-manager, docker-manager-workers]
    if: always()
    steps:
      - name: Create summary
        run: |
          STATUS="success"
          if [ "${{ needs.docker-api.result }}" != "success" ] || \
             [ "${{ needs.docker-manager.result }}" != "success" ] || \
             [ "${{ needs.docker-manager-workers.result }}" != "success" ]; then
            STATUS="failure"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## CD Pipeline Summary

          **Branch**: \`${{ github.ref_name }}\`
          **Commit**: \`${{ github.sha }}\`
          **Status**: ${STATUS}

          ### Results

          | Job | Status |
          |-----|--------|
          | Release | ${{ needs.release.result == 'success' && 'Pass' || needs.release.result == 'failure' && 'Fail' || 'Skip' }} |
          | Sync use-zedaapi | ${{ needs.sync-public-repo.result == 'success' && 'Pass' || needs.sync-public-repo.result == 'failure' && 'Fail' || 'Skip' }} |
          | API Build & Push | ${{ needs.docker-api.result == 'success' && 'Pass' || needs.docker-api.result == 'failure' && 'Fail' || 'Skip' }} |
          | Manager Build & Push | ${{ needs.docker-manager.result == 'success' && 'Pass' || needs.docker-manager.result == 'failure' && 'Fail' || 'Skip' }} |
          | Manager Workers Build & Push | ${{ needs.docker-manager-workers.result == 'success' && 'Pass' || needs.docker-manager-workers.result == 'failure' && 'Fail' || 'Skip' }} |

          ### Images

          | Image | Version | Platforms |
          |-------|---------|-----------|
          | \`${{ vars.DOCKERHUB_USERNAME }}/zedaapi\` | \`${{ needs.docker-api.outputs.version || 'N/A' }}\` | \`linux/amd64\` |
          | \`${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager\` | \`${{ needs.docker-manager.outputs.version || 'N/A' }}\` | \`linux/amd64\` |
          | \`${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager-workers\` | \`${{ needs.docker-manager-workers.outputs.version || 'N/A' }}\` | \`linux/amd64\` |

          ### Tags

          All images tagged with: \`latest\`, \`${{ needs.docker-api.outputs.version || 'N/A' }}\`, \`sha-${GITHUB_SHA::7}\`

          ---
          **Workflow**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
