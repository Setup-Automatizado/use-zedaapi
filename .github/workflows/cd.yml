name: CD - Release & Push to Docker Hub

on:
  push:
    branches:
      - main

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  GO_VERSION: "1.25"
  DOCKERHUB_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/zedaapi
  DOCKERHUB_MANAGER_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager
  DOCKERHUB_MANAGER_WORKERS_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager-workers

jobs:
  # ======================================
  # Job: Semantic Release
  # ======================================
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install semantic-release dependencies
        run: |
          npm install -g \
            semantic-release@latest \
            @semantic-release/changelog@latest \
            @semantic-release/git@latest \
            @semantic-release/github@latest \
            @semantic-release/exec@latest \
            conventional-changelog-conventionalcommits@latest

      - name: Fetch all tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          git fetch --tags --force

      - name: Run Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release || echo "No release needed"

      - name: Display release info
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "New release: v${{ steps.semantic.outputs.new_release_version }}"

  # ======================================
  # Job: Build & Push API to Docker Hub
  # ======================================
  docker-api:
    name: Build & Push API
    runs-on: ubuntu-latest
    needs: release
    if: always()
    permissions:
      contents: read
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          CURRENT_VERSION="$(cat VERSION 2>/dev/null | tr -d '[:space:]')"
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="unknown"
          fi

          if [ "${{ needs.release.outputs.new_release_published }}" = "true" ]; then
            VERSION="${{ needs.release.outputs.new_release_version }}"
          else
            VERSION="${CURRENT_VERSION}"
          fi

          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: v${VERSION}"

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.VERSION }}
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=WhatsApp API
            org.opencontainers.image.description=WhatsApp Web Multi-device API
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push API image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          target: production
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}

      - name: Display image info
        run: |
          echo "Docker image pushed to Docker Hub"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  # ======================================
  # Job: Build & Push Manager to Docker Hub
  # ======================================
  docker-manager:
    name: Build & Push Manager
    runs-on: ubuntu-latest
    needs: release
    if: always()
    permissions:
      contents: read
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          CURRENT_VERSION="$(cat VERSION 2>/dev/null | tr -d '[:space:]')"
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="unknown"
          fi

          if [ "${{ needs.release.outputs.new_release_published }}" = "true" ]; then
            VERSION="${{ needs.release.outputs.new_release_version }}"
          else
            VERSION="${CURRENT_VERSION}"
          fi

          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: v${VERSION}"

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_MANAGER_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.VERSION }}
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=ZedaAPI Manager
            org.opencontainers.image.description=SaaS Management Dashboard for ZedaAPI
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Manager image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./manager-zedaapi
          file: ./manager-zedaapi/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Display image info
        run: |
          echo "Manager image pushed to Docker Hub"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  # ======================================
  # Job: Build & Push Manager Workers to Docker Hub
  # ======================================
  docker-manager-workers:
    name: Build & Push Manager Workers
    runs-on: ubuntu-latest
    needs: release
    if: always()
    permissions:
      contents: read
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          CURRENT_VERSION="$(cat VERSION 2>/dev/null | tr -d '[:space:]')"
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="unknown"
          fi

          if [ "${{ needs.release.outputs.new_release_published }}" = "true" ]; then
            VERSION="${{ needs.release.outputs.new_release_version }}"
          else
            VERSION="${CURRENT_VERSION}"
          fi

          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: v${VERSION}"

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_MANAGER_WORKERS_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.VERSION }}
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=ZedaAPI Manager Workers
            org.opencontainers.image.description=BullMQ Background Workers for ZedaAPI Manager
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Manager Workers image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./manager-zedaapi
          file: ./manager-zedaapi/Dockerfile.workers
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Display image info
        run: |
          echo "Manager Workers image pushed to Docker Hub"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  # ======================================
  # Job: Summary
  # ======================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [release, docker-api, docker-manager, docker-manager-workers]
    if: always()
    steps:
      - name: Create summary
        run: |
          STATUS="success"
          if [ "${{ needs.docker-api.result }}" != "success" ] || \
             [ "${{ needs.docker-manager.result }}" != "success" ] || \
             [ "${{ needs.docker-manager-workers.result }}" != "success" ]; then
            STATUS="failure"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Docker Hub Push Summary

          **Branch**: \`${{ github.ref_name }}\`
          **Commit**: \`${{ github.sha }}\`
          **Status**: ${STATUS}

          ### Results

          | Job | Status |
          |-----|--------|
          | Release | ${{ needs.release.result == 'success' && 'Pass' || needs.release.result == 'failure' && 'Fail' || 'Skip' }} |
          | API Build & Push | ${{ needs.docker-api.result == 'success' && 'Pass' || needs.docker-api.result == 'failure' && 'Fail' || 'Skip' }} |
          | Manager Build & Push | ${{ needs.docker-manager.result == 'success' && 'Pass' || needs.docker-manager.result == 'failure' && 'Fail' || 'Skip' }} |
          | Manager Workers Build & Push | ${{ needs.docker-manager-workers.result == 'success' && 'Pass' || needs.docker-manager-workers.result == 'failure' && 'Fail' || 'Skip' }} |

          ### Images

          | Image | Version | Platforms |
          |-------|---------|-----------|
          | \`${{ vars.DOCKERHUB_USERNAME }}/zedaapi\` | \`${{ needs.docker-api.outputs.version || 'N/A' }}\` | \`linux/amd64\` |
          | \`${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager\` | \`${{ needs.docker-manager.outputs.version || 'N/A' }}\` | \`linux/amd64\` |
          | \`${{ vars.DOCKERHUB_USERNAME }}/zedaapi-manager-workers\` | \`${{ needs.docker-manager-workers.outputs.version || 'N/A' }}\` | \`linux/amd64\` |

          ### Tags

          All images tagged with: \`latest\`, \`${{ needs.docker-api.outputs.version || 'N/A' }}\`, \`sha-${GITHUB_SHA::7}\`

          ---
          **Workflow**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
