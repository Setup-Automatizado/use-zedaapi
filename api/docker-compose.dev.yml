services:
  postgres:
    image: postgres:16
    container_name: zedaapi-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: zedaapi
      POSTGRES_PASSWORD: zedaapi
      POSTGRES_DB: zedaapi_api
    command: ["postgres", "-c", "max_connections=300", "-c", "shared_buffers=256MB"]
    volumes:
      - postgres_zedaapi_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    container_name: zedaapi-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - redis_zedaapi_data:/data
    ports:
      - "6379:6379"

  minio:
    image: quay.io/minio/minio:RELEASE.2025-04-08T15-41-24Z
    container_name: zedaapi-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: zedaapi
      MINIO_ROOT_PASSWORD: zedaapisecret
      MINIO_PROMETHEUS_AUTH_TYPE: public
    command: ["server", "/data", "--console-address", ":9001"]
    volumes:
      - minio_zedaapi_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"

  # api:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile
  #     target: development
  #     args:
  #       TARGETARCH: ${TARGETARCH:-arm64}
  #   restart: unless-stopped
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     minio:
  #       condition: service_healthy
  #   environment:
  #     # App Configuration
  #     APP_ENV: development
  #     HTTP_ADDR: 0.0.0.0:8080
  #     LOG_LEVEL: debug

  #     # Database - API
  #     POSTGRES_DSN: postgres://zedaapi:zedaapi@postgres:5432/zedaapi_api?sslmode=disable
  #     POSTGRES_MAX_CONNS: 32

  #     # Database - WhatsApp Store
  #     WAMEOW_POSTGRES_DSN: postgres://zedaapi:zedaapi@postgres:5432/zedaapi_store?sslmode=disable
  #     WAMEOW_LOG_LEVEL: INFO

  #     # Redis
  #     REDIS_ADDR: redis:6379
  #     REDIS_USERNAME: ""
  #     REDIS_PASSWORD: ""
  #     REDIS_DB: 0
  #     REDIS_TLS_ENABLED: "false"

  #     # MinIO/S3
  #     S3_ENDPOINT: http://minio:9000
  #     S3_ACCESS_KEY: zedaapi
  #     S3_SECRET_KEY: zedaapisecret
  #     S3_BUCKET: whatsapp-media
  #     S3_REGION: us-east-1
  #     S3_USE_SSL: "false"
  #     S3_URL_EXPIRATION: 30d

  #     # Workers
  #     WEBHOOK_DISPATCHER_CONCURRENCY: 8
  #     MEDIA_WORKER_CONCURRENCY: 4

  #     # Observability
  #     PROMETHEUS_NAMESPACE: whatsapp
  #     SENTRY_DSN: ""
  #     SENTRY_ENVIRONMENT: development
  #     SENTRY_RELEASE: dev

  #     # Authentication
  #     PARTNER_AUTH_TOKEN: dev-partner-token-123

  #   # NOTE: When using deploy.replicas, ports are managed by Docker Compose
  #   # Access API via Nginx load balancer on port 8080
  #   # Individual replicas get dynamic ports (use `docker compose ps` to see them)
  #   ports:
  #     - "8080:8080"
  #   volumes:
  #     - ../:/app
  #   deploy:
  #     replicas: 3


  # # Nginx load balancer
  # nginx:
  #   image: nginx:alpine
  #   container_name: zedaapi-nginx
  #   restart: unless-stopped
  #   depends_on:
  #     - api
  #   ports:
  #     - "8080:80"
  #   volumes:
  #     - ./nginx.dev.conf:/etc/nginx/nginx.conf:ro


volumes:
  postgres_zedaapi_data:
  minio_zedaapi_data:
  redis_zedaapi_data:

networks:
  default:
    name: zedaapi-net
