{
  "openapi": "3.1.0",
  "info": {
    "title": "FunnelChat API (Whatsmeow Bridge)",
    "version": "0.1.0",
    "description": "REST API compatible with Z-API schemas, backed by Whatsmeow.\nThe specification currently covers the instance management surface implemented in this phase.\n"
  },
  "servers": [
    {
      "url": "https://api.example.com",
      "description": "Production placeholder"
    },
    {
      "url": "http://localhost:8080",
      "description": "Local development"
    }
  ],
  "components": {
    "securitySchemes": {
      "ClientTokenAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "Client-Token",
        "description": "Instance client token obtained during provisioning."
      },
      "PartnerBearer": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Partner integrator bearer token."
      }
    },
    "parameters": {
      "InstanceId": {
        "name": "instanceId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Unique instance identifier."
      },
      "InstanceToken": {
        "name": "instanceToken",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Token returned during provisioning."
      }
    },
    "schemas": {
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string"
          }
        },
        "required": [
          "error"
        ]
      },
      "InstanceStatusResponse": {
        "type": "object",
        "properties": {
          "instanceId": {
            "type": "string",
            "format": "uuid"
          },
          "connected": {
            "type": "boolean"
          },
          "storeJid": {
            "type": "string",
            "nullable": true
          },
          "lastConnected": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "autoReconnect": {
            "type": "boolean"
          },
          "workerAssigned": {
            "type": "string"
          },
          "subscriptionActive": {
            "type": "boolean"
          }
        },
        "required": [
          "instanceId",
          "connected",
          "autoReconnect",
          "workerAssigned",
          "subscriptionActive"
        ],
        "additionalProperties": false
      },
      "QRCodeImageResponse": {
        "type": "object",
        "properties": {
          "image": {
            "type": "string",
            "description": "PNG image encoded as data URL (`data:image/png;base64,...`)."
          }
        },
        "required": [
          "image"
        ],
        "additionalProperties": false
      },
      "PhoneCodeResponse": {
        "type": "object",
        "properties": {
          "code": {
            "type": "string",
            "description": "Six-character pairing code formatted with dash (e.g., `ABCD-EF`)."
          }
        },
        "required": [
          "code"
        ],
        "additionalProperties": false
      },
      "WebhookSettings": {
        "type": "object",
        "properties": {
          "deliveryCallbackUrl": {
            "type": "string",
            "format": "uri",
            "nullable": true
          },
          "receivedCallbackUrl": {
            "type": "string",
            "format": "uri",
            "nullable": true
          },
          "receivedAndDeliveryCallbackUrl": {
            "type": "string",
            "format": "uri",
            "nullable": true
          },
          "messageStatusCallbackUrl": {
            "type": "string",
            "format": "uri",
            "nullable": true
          },
          "disconnectedCallbackUrl": {
            "type": "string",
            "format": "uri",
            "nullable": true
          },
          "presenceChatCallbackUrl": {
            "type": "string",
            "format": "uri",
            "nullable": true
          },
          "connectedCallbackUrl": {
            "type": "string",
            "format": "uri",
            "nullable": true
          },
          "notifySentByMe": {
            "type": "boolean"
          }
        },
        "additionalProperties": false
      },
      "WebhookValueRequest": {
        "type": "object",
        "properties": {
          "value": {
            "type": "string",
            "description": "HTTPS endpoint that should receive the webhook."
          }
        },
        "required": [
          "value"
        ],
        "additionalProperties": false
      },
      "WebhookEveryRequest": {
        "type": "object",
        "properties": {
          "value": {
            "type": "string",
            "description": "HTTPS endpoint applied to all webhook types."
          },
          "notifySentByMe": {
            "type": "boolean",
            "description": "Optional flag to also toggle the notify-sent-by-me option."
          }
        },
        "required": [
          "value"
        ],
        "additionalProperties": false
      },
      "NotifySentByMeRequest": {
        "type": "object",
        "properties": {
          "notifySentByMe": {
            "type": "boolean"
          }
        },
        "required": [
          "notifySentByMe"
        ],
        "additionalProperties": false
      },
      "WebhookUpdateResponse": {
        "type": "object",
        "properties": {
          "value": {
            "type": "boolean",
            "description": "Indicates whether the update was accepted."
          },
          "webhooks": {
            "$ref": "#/components/schemas/WebhookSettings"
          }
        },
        "required": [
          "value"
        ],
        "additionalProperties": false
      },
      "InstanceQRCodeResponse": {
        "type": "object",
        "properties": {
          "code": {
            "type": "string"
          }
        },
        "required": [
          "code"
        ],
        "additionalProperties": false
      },
      "OperationStatusResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string"
          }
        },
        "required": [
          "status"
        ],
        "additionalProperties": false
      },
      "HealthStatusResponse": {
        "type": "object",
        "description": "Liveness probe response.",
        "properties": {
          "status": {
            "type": "string",
            "example": "ok"
          },
          "service": {
            "type": "string",
            "example": "whatsapp-api"
          }
        },
        "required": [
          "status",
          "service"
        ],
        "additionalProperties": false
      },
      "ReadinessComponentStatus": {
        "type": "object",
        "description": "Status information for a single dependency checked by the readiness probe.",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "healthy",
              "degraded",
              "unhealthy"
            ]
          },
          "error": {
            "type": "string",
            "nullable": true
          },
          "duration_ms": {
            "type": "integer",
            "format": "int64",
            "description": "Time spent executing the check in milliseconds."
          },
          "circuit_state": {
            "type": "string",
            "nullable": true,
            "description": "Circuit breaker state reported by the lock manager (when available)."
          }
        },
        "required": [
          "status"
        ],
        "additionalProperties": false
      },
      "ReadinessResponse": {
        "type": "object",
        "description": "Readiness probe payload containing aggregated dependency status.",
        "properties": {
          "ready": {
            "type": "boolean"
          },
          "observed_at": {
            "type": "string",
            "format": "date-time"
          },
          "checks": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/components/schemas/ReadinessComponentStatus"
            },
            "description": "Map of dependency name to component status (e.g. `database`, `redis`)."
          }
        },
        "required": [
          "ready",
          "observed_at",
          "checks"
        ],
        "additionalProperties": false
      },
      "PartnerInstanceCreateRequest": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Display name for the instance."
          },
          "sessionName": {
            "type": "string",
            "description": "Optional session identifier used by partners."
          },
          "deliveryCallbackUrl": {
            "type": "string",
            "format": "uri"
          },
          "receivedCallbackUrl": {
            "type": "string",
            "format": "uri"
          },
          "receivedAndDeliveryCallbackUrl": {
            "type": "string",
            "format": "uri"
          },
          "disconnectedCallbackUrl": {
            "type": "string",
            "format": "uri"
          },
          "connectedCallbackUrl": {
            "type": "string",
            "format": "uri"
          },
          "messageStatusCallbackUrl": {
            "type": "string",
            "format": "uri"
          },
          "presenceChatCallbackUrl": {
            "type": "string",
            "format": "uri"
          },
          "notifySentByMe": {
            "type": "boolean",
            "default": false
          },
          "callRejectAuto": {
            "type": "boolean",
            "description": "When true, the instance rejects calls automatically."
          },
          "callRejectMessage": {
            "type": "string",
            "description": "Message returned when a call is rejected automatically."
          },
          "autoReadMessage": {
            "type": "boolean",
            "description": "When true, messages are marked as read automatically."
          },
          "isDevice": {
            "type": "boolean",
            "default": false
          },
          "businessDevice": {
            "type": "boolean",
            "default": true
          }
        },
        "required": [
          "name"
        ],
        "additionalProperties": false
      },
      "PartnerInstanceCreateResponse": {
        "type": "object",
        "properties": {
          "instanceId": {
            "type": "string",
            "format": "uuid"
          },
          "name": {
            "type": "string"
          },
          "sessionName": {
            "type": "string"
          },
          "clientToken": {
            "type": "string"
          },
          "instanceToken": {
            "type": "string"
          },
          "subscriptionActive": {
            "type": "boolean"
          },
          "callRejectAuto": {
            "type": "boolean"
          },
          "callRejectMessage": {
            "type": "string",
            "nullable": true
          },
          "autoReadMessage": {
            "type": "boolean"
          },
          "middleware": {
            "type": "string",
            "enum": [
              "web",
              "mobile"
            ]
          },
          "webhooks": {
            "$ref": "#/components/schemas/WebhookSettings"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "instanceId",
          "name",
          "sessionName",
          "clientToken",
          "instanceToken",
          "subscriptionActive",
          "createdAt"
        ],
        "additionalProperties": false
      },
      "InstanceListItem": {
        "type": "object",
        "properties": {
          "instanceId": {
            "type": "string",
            "format": "uuid"
          },
          "name": {
            "type": "string"
          },
          "sessionName": {
            "type": "string"
          },
          "clientToken": {
            "type": "string"
          },
          "instanceToken": {
            "type": "string"
          },
          "storeJid": {
            "type": "string",
            "nullable": true
          },
          "isDevice": {
            "type": "boolean"
          },
          "businessDevice": {
            "type": "boolean"
          },
          "subscriptionActive": {
            "type": "boolean"
          },
          "callRejectAuto": {
            "type": "boolean"
          },
          "callRejectMessage": {
            "type": "string",
            "nullable": true
          },
          "autoReadMessage": {
            "type": "boolean"
          },
          "canceledAt": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time"
          },
          "middleware": {
            "type": "string",
            "enum": [
              "web",
              "mobile"
            ]
          },
          "phoneConnected": {
            "type": "boolean"
          },
          "whatsappConnected": {
            "type": "boolean"
          },
          "due": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "webhooks": {
            "$ref": "#/components/schemas/WebhookSettings"
          }
        },
        "required": [
          "instanceId",
          "name",
          "sessionName",
          "clientToken",
          "instanceToken",
          "isDevice",
          "businessDevice",
          "subscriptionActive",
          "createdAt",
          "updatedAt"
        ],
        "additionalProperties": false
      },
      "InstanceListResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/InstanceListItem"
            }
          },
          "page": {
            "type": "integer",
            "minimum": 1
          },
          "pageSize": {
            "type": "integer",
            "minimum": 1
          },
          "total": {
            "type": "integer",
            "minimum": 0
          }
        },
        "required": [
          "data",
          "page",
          "pageSize",
          "total"
        ],
        "additionalProperties": false
      }
    }
  },
  "paths": {
    "/health": {
      "get": {
        "tags": [
          "System"
        ],
        "summary": "Liveness probe",
        "description": "Returns a JSON object indicating that the API process is running.",
        "operationId": "healthLiveness",
        "responses": {
          "200": {
            "description": "Process is alive and capable of serving traffic.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthStatusResponse"
                }
              }
            }
          }
        }
      }
    },
    "/ready": {
      "get": {
        "tags": [
          "System"
        ],
        "summary": "Readiness probe",
        "description": "Checks critical dependencies (Postgres, Redis lock manager). The service is considered ready when all reported components are `healthy`. Any `degraded` or `unhealthy` status results in a `503` response.\n",
        "operationId": "healthReadiness",
        "responses": {
          "200": {
            "description": "Service is ready to receive traffic.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ReadinessResponse"
                },
                "examples": {
                  "ready": {
                    "value": {
                      "ready": true,
                      "observed_at": "2024-05-28T10:59:00+00:00",
                      "checks": {
                        "database": {
                          "status": "healthy",
                          "duration_ms": 12
                        },
                        "redis": {
                          "status": "healthy",
                          "duration_ms": 8,
                          "circuit_state": "CLOSED"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "503": {
            "description": "At least one dependency is degraded or unavailable.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ReadinessResponse"
                },
                "examples": {
                  "degraded": {
                    "value": {
                      "ready": false,
                      "observed_at": "2024-05-28T11:01:00+00:00",
                      "checks": {
                        "database": {
                          "status": "unhealthy",
                          "error": "database not configured",
                          "duration_ms": 3
                        },
                        "redis": {
                          "status": "degraded",
                          "error": "fallback lock in use",
                          "duration_ms": 7,
                          "circuit_state": "OPEN"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/instances": {
      "get": {
        "tags": [
          "Partner"
        ],
        "summary": "List partner instances",
        "description": "Returns a paginated list of managed WhatsApp instances for the partner account.",
        "operationId": "listInstances",
        "security": [
          {
            "PartnerBearer": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "query",
            "schema": {
              "type": "string"
            },
            "description": "Filter results by instance name or session name."
          },
          {
            "in": "query",
            "name": "middleware",
            "schema": {
              "type": "string"
            },
            "description": "Informational middleware flag (matches Z-API contract)."
          },
          {
            "in": "query",
            "name": "page",
            "required": true,
            "schema": {
              "type": "integer",
              "minimum": 1
            },
            "description": "Page number (1-indexed).",
            "example": 1
          },
          {
            "in": "query",
            "name": "pageSize",
            "required": true,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 200
            },
            "description": "Page size (defaults to 15 as in Z-API examples).",
            "example": 15
          }
        ],
        "responses": {
          "200": {
            "description": "List of instances owned by the partner.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InstanceListResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing or invalid Partner bearer token.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/status": {
      "get": {
        "tags": [
          "Instances"
        ],
        "summary": "Retrieve instance status",
        "description": "Mirrors Z-API `/status`, returning live connectivity information for a provisioned instance.",
        "operationId": "getInstanceStatus",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "responses": {
          "200": {
            "description": "Instance status snapshot",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InstanceStatusResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "Instance not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/qr-code": {
      "get": {
        "tags": [
          "Instances"
        ],
        "summary": "Fetch QR code for pairing",
        "description": "Mirrors Z-API `/qr-code`, returning the current QR string required to link a phone.",
        "operationId": "getInstanceQRCode",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "responses": {
          "200": {
            "description": "Current QR code for pairing",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InstanceQRCodeResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/qr-code/image": {
      "get": {
        "tags": [
          "Instances"
        ],
        "summary": "Fetch QR code as base64 image",
        "description": "Mirrors Z-API `/qr-code/image`, returning a PNG image encoded in base64 for rendering in clients.",
        "operationId": "getInstanceQRCodeImage",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "responses": {
          "200": {
            "description": "QR code rendered as base64 PNG data URL.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/QRCodeImageResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/phone-code/{phone}": {
      "get": {
        "tags": [
          "Instances"
        ],
        "summary": "Fetch phone pairing code",
        "description": "Mirrors Z-API `/phone-code/{phone}`, returning a code that can be typed into WhatsApp instead of scanning the QR code.",
        "operationId": "getInstancePhoneCode",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          },
          {
            "in": "path",
            "name": "phone",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "International phone number (numbers only) used for code pairing."
          }
        ],
        "responses": {
          "200": {
            "description": "Pairing code generated for the provided phone number.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PhoneCodeResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid phone number supplied.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-webhook-delivery": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update delivery webhook",
        "description": "Mirrors Z-API `/update-webhook-delivery`, configuring the sent-message webhook endpoint.",
        "operationId": "updateWebhookDelivery",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookValueRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-webhook-received": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update received webhook",
        "description": "Mirrors Z-API `/update-webhook-received`, configuring the incoming message webhook endpoint.",
        "operationId": "updateWebhookReceived",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookValueRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-webhook-received-delivery": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update received+delivery webhook",
        "description": "Mirrors Z-API `/update-webhook-received-delivery`, configuring the webhook used when `notifySentByMe` is enabled.",
        "operationId": "updateWebhookReceivedDelivery",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookValueRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-webhook-message-status": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update message status webhook",
        "description": "Mirrors Z-API `/update-webhook-message-status`, configuring delivery-read status updates.",
        "operationId": "updateWebhookMessageStatus",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookValueRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-webhook-disconnected": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update disconnected webhook",
        "description": "Mirrors Z-API `/update-webhook-disconnected`, configuring the disconnect notification endpoint.",
        "operationId": "updateWebhookDisconnected",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookValueRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-webhook-connected": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update connected webhook",
        "description": "Mirrors Z-API `/update-webhook-connected`, configuring the connection notification endpoint.",
        "operationId": "updateWebhookConnected",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookValueRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-webhook-chat-presence": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update chat presence webhook",
        "description": "Mirrors Z-API `/update-webhook-chat-presence`, configuring the typing/presence webhook endpoint.",
        "operationId": "updateWebhookChatPresence",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookValueRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-notify-sent-by-me": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Toggle notify-sent-by-me",
        "description": "Mirrors Z-API `/update-notify-sent-by-me`, enabling or disabling callbacks for messages sent by the instance.",
        "operationId": "updateNotifySentByMe",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/NotifySentByMeRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Setting updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/update-every-webhooks": {
      "put": {
        "tags": [
          "Instances"
        ],
        "summary": "Update all webhooks at once",
        "description": "Mirrors Z-API `/update-every-webhooks`, applying the same HTTPS endpoint to every webhook type.",
        "operationId": "updateEveryWebhooks",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookEveryRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhooks updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload or non-HTTPS URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/restart": {
      "post": {
        "tags": [
          "Instances"
        ],
        "summary": "Restart an instance connection",
        "description": "Equivalent to Z-API `/restart`, forcing the client to reconnect to WhatsApp.",
        "operationId": "restartInstance",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "responses": {
          "202": {
            "description": "Restart signal accepted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OperationStatusResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/disconnect": {
      "post": {
        "tags": [
          "Instances"
        ],
        "summary": "Complete disconnect with cleanup (Logout)",
        "description": "Performs a complete disconnect with full cleanup, equivalent to logout/reset.\n\n**This operation performs the following actions:**\n- \u2705 Disables auto-reconnect to prevent automatic reconnection\n- \u2705 Disconnects WebSocket connection immediately\n- \u2705 **Deletes device store from whatsmeow_store database**\n- \u2705 Stops lock refresh goroutine\n- \u2705 Releases Redis distributed lock\n- \u2705 Removes client from in-memory registry\n- \u2705 Clears store_jid in api_core database (sets to NULL)\n\n**Important Notes:**\n- The instance record remains in the database (status becomes \"disconnected\")\n- To permanently delete the instance, use `DELETE /partner/instances/{instanceId}`\n- After disconnect, you can reconnect by calling `/qrcode` or `/pairphone`\n- All webhook configurations are preserved\n\n**Use Cases:**\n- User logout from WhatsApp\n- Switching to a different phone number\n- Temporary disconnection for maintenance\n- Resetting a stuck connection\n\n**Comparison with DELETE endpoint:**\n- Disconnect: Keeps instance record, allows reconnection\n- Delete: Permanent removal, cannot be recovered\n",
        "operationId": "disconnectInstance",
        "security": [
          {
            "ClientTokenAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "responses": {
          "202": {
            "description": "Complete disconnect with cleanup accepted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OperationStatusResponse"
                },
                "example": {
                  "status": "disconnecting"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized (invalid client token or instance token)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "Instance not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/integrator/on-demand": {
      "post": {
        "tags": [
          "Partner"
        ],
        "summary": "Partner creates an instance on demand",
        "description": "Mirrors Z-API partner endpoint for provisioning instances via integrator credentials.",
        "operationId": "partnerCreateInstance",
        "security": [
          {
            "PartnerBearer": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PartnerInstanceCreateRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Instance created for partner",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PartnerInstanceCreateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/integrator/on-demand/subscription": {
      "post": {
        "tags": [
          "Partner"
        ],
        "summary": "Activate partner subscription",
        "description": "Enables on-demand billing/usage for the specified instance (Z-API parity).",
        "operationId": "partnerSubscribeInstance",
        "security": [
          {
            "PartnerBearer": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "responses": {
          "200": {
            "description": "Subscription activated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OperationStatusResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "Instance not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}/token/{instanceToken}/integrator/on-demand/cancel": {
      "post": {
        "tags": [
          "Partner"
        ],
        "summary": "Cancel partner subscription",
        "description": "Cancels the on-demand subscription for the instance, matching Z-API behaviour.",
        "operationId": "partnerCancelInstance",
        "security": [
          {
            "PartnerBearer": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/InstanceId"
          },
          {
            "$ref": "#/components/parameters/InstanceToken"
          }
        ],
        "responses": {
          "200": {
            "description": "Subscription cancelled",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OperationStatusResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "Instance not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/instances/{instanceId}": {
      "delete": {
        "tags": [
          "Partner"
        ],
        "summary": "Permanently delete instance (Partner API)",
        "description": "**\u26a0\ufe0f IRREVERSIBLE OPERATION \u26a0\ufe0f**\n\nPermanently deletes a WhatsApp instance including all associated data from both databases.\n\n**Complete Cleanup Operations:**\n- \u2705 Disconnects the WhatsApp client immediately\n- \u2705 Disables auto-reconnect to prevent reconnection\n- \u2705 **Deletes device store from whatsmeow_store database**\n- \u2705 Stops lock refresh goroutine\n- \u2705 Releases Redis distributed lock\n- \u2705 Removes client from in-memory registry\n- \u2705 **Deletes instance record from api_core database**\n- \u2705 **Deletes all webhook configurations (CASCADE)**\n- \u2705 **Deletes all webhook outbox entries (CASCADE)**\n- \u2705 **Deletes all webhook DLQ entries (manual deletion)**\n- \u2705 **Deletes all instance event logs (manual deletion)**\n\n**Database Deletion Strategy:**\n- Uses transaction to ensure ACID compliance\n- Manually deletes tables without CASCADE constraints (webhook_dlq, instance_events_log)\n- Relies on CASCADE for webhook_configs and webhook_outbox\n- Deletes device credentials from separate whatsmeow_store database\n\n**Authentication:**\n- Requires Partner Bearer token only (no instance token needed)\n- This is a Partner-level administrative operation\n\n**Use Cases:**\n- Cleanup of test/development instances\n- Customer offboarding and data removal\n- GDPR/data deletion compliance requests\n- Freeing resources from inactive instances\n\n**Important Notes:**\n- **This operation cannot be undone or reversed**\n- All data associated with the instance is permanently lost\n- The instance cannot be recovered or reconnected after deletion\n- Consider using `/disconnect` if you need to preserve the instance record\n",
        "operationId": "partnerDeleteInstance",
        "security": [
          {
            "PartnerBearer": []
          }
        ],
        "parameters": [
          {
            "name": "instanceId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "Unique instance identifier to permanently delete.",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          }
        ],
        "responses": {
          "200": {
            "description": "Instance permanently deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "string",
                      "enum": [
                        "deleted"
                      ],
                      "description": "Confirmation that instance was deleted",
                      "example": "deleted"
                    }
                  },
                  "required": [
                    "status"
                  ]
                },
                "example": {
                  "status": "deleted"
                }
              }
            }
          },
          "400": {
            "description": "Invalid instance ID format (must be valid UUID)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "invalid instance id"
                }
              }
            }
          },
          "401": {
            "description": "Missing or invalid Partner bearer token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "unauthorized"
                }
              }
            }
          },
          "404": {
            "description": "Instance not found in database",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "instance not found"
                }
              }
            }
          },
          "500": {
            "description": "Internal error during deletion (transaction may have been rolled back)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "delete instance from database: connection error"
                }
              }
            }
          }
        }
      }
    }
  }
}