package main

import (
	"errors"

	"go.mau.fi/whatsmeow/proto/waE2E"
	"google.golang.org/protobuf/proto"
)

var (
	ErrEmptyButtons            = errors.New("empty Array buttons")
	ErrEmptyListSections       = errors.New("empty Array sections for list message")
	ErrHeaderCantBeNull        = errors.New("header can´t be null")
	ErrTextCantBeNull          = errors.New("text can´t be null")
	ErrTextMax30Char           = errors.New("text max 30 characters")
	ErrTextMax1024Char         = errors.New("text max 1024 characters")
	ErrTitleMax60Char          = errors.New("title max 60 characters")
	ErrTitleMax24Char          = errors.New("title max 24 characters")
	ErrTitleCantBeNull         = errors.New("title can´t be null")
	ErrFooterMax1024Char       = errors.New("footer max 1024 characters")
	ErrButtonsLimit            = errors.New("3 buttons is the limit")
	ErrBodyCantBeNull          = errors.New("body can´t be null")
	ErrBodyMax1024Char         = errors.New("body max 1024 characters")
	ErrButtonDisplayCantBeNull = errors.New("buttonDisplay can´t be null")
	ErrButtonDisplayMax20Char  = errors.New("buttonDisplay max 20 characters")
	ErrFooterMax60Char         = errors.New("footer max 60 characters")
	ErrRowsCantBeNull          = errors.New("rows can´t be empty")
	ErrDescriptionMax1024Char  = errors.New("description max 1024 characters")
)

type ListMessageFactory struct {
	Title       string                      `json:"title"`
	Description string                      `json:"description"`
	ButtonText  string                      `json:"button_text"`
	Footer      string                      `json:"footer"`
	Sections    []ListMessageSectionFactory `json:"sections"`
}

func (l ListMessageFactory) New(title string, body string, buttonDisplay string, footer string, sections []*waE2E.ListMessage_Section, ctx *waE2E.ContextInfo) (*waE2E.Message, error) {
	if len(title) > 60 {
		return nil, ErrTitleMax60Char
	}

	if len(body) == 0 {
		return nil, ErrBodyCantBeNull
	}

	if len(body) > 1024 {
		return nil, ErrBodyMax1024Char
	}

	if len(buttonDisplay) == 0 {
		return nil, ErrButtonDisplayCantBeNull
	}

	if len(buttonDisplay) > 20 {
		return nil, ErrButtonDisplayMax20Char
	}

	if len(footer) > 60 {
		return nil, ErrFooterMax60Char
	}

	if len(sections) == 0 {
		return nil, ErrEmptyListSections
	}

	return &waE2E.Message{
		ListMessage: &waE2E.ListMessage{
			Title:       proto.String(title),
			Description: proto.String(body),
			FooterText:  proto.String(footer),
			ButtonText:  proto.String(buttonDisplay),
			ListType:    waE2E.ListMessage_SINGLE_SELECT.Enum(),
			Sections:    sections,
			ContextInfo: ctx,
		},
	}, nil
}

type ListMessageSectionFactory struct {
	Title string                  `json:"title"`
	Rows  []ListMessageRowFactory `json:"rows"`
}

func (l ListMessageSectionFactory) New(title string, rows []*waE2E.ListMessage_Row) (*waE2E.ListMessage_Section, error) {
	if len(title) > 60 {
		return nil, ErrTitleMax60Char
	}

	if len(rows) == 0 {
		return nil, ErrRowsCantBeNull
	}

	return &waE2E.ListMessage_Section{
		Title: proto.String(title),
		Rows:  rows,
	}, nil
}

type ListMessageRowFactory struct {
	ID          string `json:"id"`
	Title       string `json:"title"`
	Description string `json:"description"`
}

func (l ListMessageRowFactory) New(title, description, id string) (*waE2E.ListMessage_Row, error) {

	return &waE2E.ListMessage_Row{
		RowID:       proto.String(id),
		Title:       proto.String(title),
		Description: proto.String(description),
	}, nil
}
